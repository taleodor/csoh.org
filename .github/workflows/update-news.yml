name: Update News

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'update_news.py'

jobs:
  update-news:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Update news.html from feeds
        run: python3 update_news.py

      - name: Detect changed files
        id: changes
        run: |
          set -euo pipefail
          files="$(git diff --name-only)"

          if [ -z "$files" ]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "only_news_html=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "has_changes=true" >> "$GITHUB_OUTPUT"

          count="$(printf '%s\n' "$files" | sed '/^$/d' | wc -l | tr -d ' ')"
          if [ "$count" = "1" ] && [ "$files" = "news.html" ]; then
            echo "only_news_html=true" >> "$GITHUB_OUTPUT"
          else
            echo "only_news_html=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Pull Request
        id: cpr
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT_TOKEN }}
          commit-message: 'chore: update news feed content'
          title: 'chore: Update news articles'
          body: |
            This PR was automatically created by the Update News workflow.

            The news feed content in `news.html` has been refreshed from configured RSS/Atom sources.

            **Changes:**
            - Updated article cards in `news.html`
            - Updated `dateModified` in JSON-LD

            This can be safely reviewed and merged.
          branch: update-news-content
          delete-branch: true
          labels: automated, content

      - name: Enable PR auto-merge when only news.html changed
        if: steps.changes.outputs.only_news_html == 'true' && steps.cpr.outputs.pull-request-number != ''
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.PAT_TOKEN }}
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: squash
